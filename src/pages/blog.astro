---
import { readAll } from "../lib/markdoc/read";
import { blog } from "../lib/markdoc/frontmatter.schema";
import PageLayout from "../layouts/PageLayout.astro";
import PageMeta from "../components/PageMeta.astro";
import TagList from "../components/TagList.astro";
import BlogPostItem from "../components/BlogPostItem.astro";
import { SITE_TITLE } from "../config";
import { getReadingTime } from "../lib/reading-time";

const posts = await readAll({
  directory: "blog",
  frontmatterSchema: blog,
});

const sortedPosts = posts
  .filter((p) => p.frontmatter.draft !== true)
  .sort(
    (a, b) =>
      new Date(b.frontmatter.date).valueOf() -
      new Date(a.frontmatter.date).valueOf(),
  );

const postsWithMeta = sortedPosts.map((post) => {
  const { words, minutes } = getReadingTime(post.rawContent);
  return {
    ...post,
    words,
    minutes,
    frontmatter: {
      ...post.frontmatter,
      tags:
        post.frontmatter.external === false ? post.frontmatter.tags : undefined,
    },
  };
});

// Group posts by year
const postsByYear = postsWithMeta.reduce(
  (acc, post) => {
    const year = new Date(post.frontmatter.date).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof postsWithMeta>,
);

// Get years in descending order
const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

// Get all unique tags
const allTags = new Set<string>();
sortedPosts.forEach((post) => {
  if (post.frontmatter.external === false && post.frontmatter.tags) {
    post.frontmatter.tags.forEach((tag: string) => allTags.add(tag));
  }
});
const uniqueTags = Array.from(allTags).sort();
---

<PageLayout>
  <PageMeta
    title={`Tech Blog | ${SITE_TITLE}`}
    description="Technical blog covering Hyprland development, DevOps practices, observability, distributed systems, and automation. Articles on rsyslog, Grafana Loki, Promtail, Hyprland monitor management, and event-driven workflows."
    keywords={[
      "Tech Blog",
      "DevOps Blog",
      "Hyprland Blog",
      "SRE Blog",
      "Software Engineering Blog",
      "Distributed Systems",
      "Observability",
      "Monitoring",
      "Grafana Loki",
      "Promtail",
      "Rsyslog",
      "Hyprland",
      "HyprDynamicMonitors",
      "HyprWhenThen",
      "Wayland",
      "Linux",
      "System Administration",
      "Cloud Architecture",
      "Automation",
      "Open Source",
      "Go Programming",
      "Python",
      "TypeScript",
    ]}
    slot="meta"
  />
  <section slot="main">
    <h1 class="text-4xl font-bold mb-4 text-primary-main">Technical Blog</h1>

    <div class="space-y-10">
      {
        years.map((year) => (
          <div class="relative">
            <div class="flex items-center gap-4 mb-6">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-primary-main" />
                <h2 class="text-3xl font-bold text-text-bold">{year}</h2>
              </div>
              <div class="flex-1 h-px bg-gradient-to-r from-primary-main/30 to-transparent" />
              <span class="text-sm text-text-muted font-semibold">
                {postsByYear[year].length}{" "}
                {postsByYear[year].length === 1 ? "post" : "posts"}
              </span>
            </div>
            <div class="grid md:grid-cols-2 gap-3 pl-6">
              {postsByYear[year].map((post) => (
                <BlogPostItem post={post} />
              ))}
            </div>
          </div>
        ))
      }
    </div>

    {
      uniqueTags.length > 0 && (
        <div class="mb-8 mt-8">
          <h2 class="font-semibold text-text-muted mb-3">Browse by tag</h2>
          <TagList tags={uniqueTags} />
        </div>
      )
    }
  </section>
</PageLayout>
